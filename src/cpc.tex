\section{\xlang{Directives et options spécifique à l'Amstrad CPC}{Amstrad CPC Specific features}}

\begin{xfr}
RASM intègre des options et des directives qui ne concernent que l'architecture spécifique de l'Amstrad CPC, comme l'accès aux banques mémoire, et de ses émulateurs (export DSK, snapshots). Il offre en outre le support du format cartouche.
\end{xfr}

\subsection{\xlang{Manipulation des Banques}{Bank Management}}

\begin{xfr}
Les banques mémoires du 6128 peuvent être manipulées en envoyant des données sur le port \#7F (le composant gate array), ce qui permet de les échanger par page de 16K. Pour simplifier l'écriture du code, RASM introduit des préfixes qui permettent de récuperer non pas l'adresse d'un label, mais la valeur utilisée pour sélectionner les banques.
\end{xfr}

\subsubsection{\xlang{Préfixe BANK}{BANK Prefix}}\index{BANK}\label{PBANK}

\begin{xfr}
Le préfixe \texttt{\{BANK\}} devant un label (exemple: \texttt{\{BANK\}monlabel} ) permet de récupérer la valeur de la banque mémoire dans laquelle est déclaré le label, plutôt que l'adresse du label.
Exemple d'utilisation du tag:
\end{xfr}

\begin{xen}
Using \texttt{\{BANK\}} prefix before a label (example: \texttt{\{BANK\}mylabel} ) will return the BANK number where the label is located, intead of its absolute address. For example:
\end{xen}

\begin{code}
BANK 0
  ld a,\{bank\}mysub 	; \xlang{sera assemblé comme }{will be assembled as }LD A,1
  call connect\_bank
  jp mysub
\medskip
BANK 1
  defb 'hello'
mysub
  jr \$
\end{code}

\subsubsection{\xlang{Préfixe PAGE}{PAGE Prefix}}\index{PAGE}

\begin{xfr}
  Le préfixe \texttt{\{PAGE\}} devant une référence à un label (exemple: \texttt{\{PAGE\}monlabel} ) permet de récupérer la valeur de type Gate array de la BANK dans laquelle est déclaré le label, plutôt que l'adresse du label. Par exemple pour un label situé dans la BANK 5 la valeur retournée sera \#7FC5.
  Si vous utilisez l'adressage mémoire par 64K avec la directive \texttt{BANKSET}, alors la valeur gate array sera déduite du set de 64K ainsi que de l'adresse du label (2 bits de poids fort).
  Exemple d'utilisation du tag:
\end{xfr}

\begin{xen}
  Use {PAGE} prefix before a label (example: \texttt{\{PAGE\}mylabel} ) to get a value that can be used to program the Gate Array for accessing the bank where the label is located. For example with a label located into BANK 5, \#7FC5 will be returned.
  If you are using BANKSET directive to select 4 banks in a 64K set, then the gate array value is composed by the set number and the 2 most significant bits of the label address.
  Example:
\end{xen}

\vbox{
\begin{code}
BANK 0
\  ld bc,\{PAGE\}mysub    ; \xlang{sera assemblé comme }{will be assembled }LD BC,\#7FC5
\  out (c),a
\  jp mysub
\medskip
BANK 5
\  defb 'hello'
mysub
\  jr \$
\end{code}
}

\subsubsection{\xlang{Préfixe PAGESET}{PAGESET Prefix}}\index{PAGESET}
\begin{xfr}
  Le préfixe \texttt{\{PAGESET\}} devant un label (exemple: \texttt{\{PAGESET\}monlabel} ) permet de récupérer la valeur de type "Gate Array" du \texttt{BANKSET} dans lequel est déclaré le label, plutôt que l'adresse du label. Par exemple pour un label situé dans la \texttt{BANK 5} la valeur retournée sera \#7FC2
\end{xfr}

\begin{xen}
  You can use \{PAGESET\} prefix before a label (example: \{PAGESET\}mylabel ) to program the Gate array for selecting the BANKSET where the label is located. For example, for a label stored in BANK \#5, \#7FC2 will be returned.
\end{xen}

\begin{code}
BANK 0
\  ld a,lo(\{pageset\}mysub) ; \xlang{sera assemblé comme }{will be assembled as }LD A,\#C2
\  ld b,\#7F
\  out (c),a           ; \xlang{Tout la RAM est basculée, le code est suppoosé}{whole RAM is switched, code is supposed}
\  jp mysub            ; \xlang{stocké en ROM ou a un endroit approprié}{to be stored in ROM, or in a proper place}
\medskip
BANK 5
\  defb 'hello'
mysub
\  jr \$
\end{code}

\subsection{\xlang{Export de fichiers DSK et entêtes AMSDOS}{AMSDOS headers and DSK files}}\index{AMSDOS}\index{DSK}

\subsubsection{\xlang{Entête AMSDOS}{AMSDOS Header}}

\begin{xfr}
L'utilisation de cette directive ajoute un entête Amsdos au fichier binaire produit automatiquement par Rasm. Cet entête est sans effet sur la directive \texttt{SAVE} que nous allons voir au prochain paragraphe (elle dispose de sa propre option pour ajouter cet entête à la demande).
\end{xfr}

\begin{xen}
This directive adds an AMSDOS header to the binary file generated by RASM. 
This directive has no effect on \texttt{SAVE} directive, which has its own option for adding AMSDOS header.
\end{xen}

\subsubsection{\xlang{Directive SAVE}{SAVE directive}}\index{SAVE}

\begin{verbatim}
SAVE 'filename',<address>,<size>[,AMSDOS|DSK[,'dsk filename'[,<side>]]]
\end{verbatim}

\begin{xfr}
Enregistre un fichier binaire à partir de la mémoire adresse jusqu'à adresse+taille de l'espace mémoire en cours. Bien que l'instruction \texttt{SAVE} puisse être déclarée à n'importe quel moment, les enregistrements de fichier sont toujours réalisés en fin d'assemblage si et seulement si il n'y a pas eu d'erreur. Il n'est donc pas possible d'enregistrer des états intermédiaires d'assemblage.

Lorsqu'on enregistre sur une image de disquette (DSK), le nom du fichier binaire est automatiquement tronqué et mis en majuscule si il n'est pas conforme aux limitations de l'AMSDOS.
Notez aussi que si le fichier DSK existe déja, RASM va vérifier si le fichier binaire généré existe déja dans le DSK. Si il existe, il refusera de mettre à jour le DSK, sauf si on passe l'option \texttt{-eo}. Si le DSK n'existe pas, il sera automatiquement créé.


Exemples:
\end{xfr}

\begin{xen}
Records a binary file of the given size, starting from the specified address, from current memory space. All \texttt{SAVE} directives are executed at the end of the assemblig process: there is no way to save intermediate assembling states.
%If there is no error then files will be written. 

When recording a file on a floppy image (DSK), its name will be automatically converted according to the AMSDOS format: lower cases will be replaced by upper cases, and it will be truncated.
If the DSK file doesn't exist, il will be automatically created. If it already exists, and if the binary file produced by rasm already exists on the disk, it WON'T be updated, except if \texttt{-eo} option is used.

Examples:
\end{xen}

\begin{code}
;\xlang{Sauve un fichier binaire}{Save a raw binary file}
SAVE 'myfile.bin',start,size
\medskip
;\xlang{Sauve un binaire avec un header AMSDOS}{Save a binary file with AMSDOS header}
SAVE 'myfile.bin',start,size,AMSDOS
\medskip
;\xlang{Sauve un binaire AMSDOS dans un fichier DSK}{Save a binary file (AMDOS header mandatory) on a DSK file}
SAVE 'myfile.bin',start,size,DSK,'fichierdsk.dsk'
\end{code}

\xlang{Combiné avec RUN:}{Combined with RUN:}
\begin{code}
ORG \#9000
\medskip
start:
\ call \#bb06
\ ret
end:
\medskip
RUN start
SAVE 'main.bin',start,end-start,DSK,'main.dsk'

\end{code}





\subsection{\xlang{Cartouches et Snapshots}{Snapshot and Cartridges}}\index{Snapshots}
\begin{xen}
\index{Cartridges}
\end{xen}
\begin{xfr}
\index{Cartouches}
\end{xfr}

\begin{xfr}
En plus du format DSK, RASM permet l'exportation de fichiers au format cartridge et snapshot. Ils peuvent etre utilisés par certains émulateurs (Winape, Ace, etc.). La methode pour produire les deux formats est très similaire. En début de programme, il faut utiliser les directives \texttt{BUILDCPR} ou \texttt{BUILDSNA}, \texttt{BANK} et \texttt{RUN}. C'est la directive BANK qui va provoquer la génération d'une cartouche ou d'un snapshot.
\end{xfr}

\begin{xen}
RASM also allows to generate cartridge (.crt) and snapshot (.sna) files. These files can be used by some emulators such as Wanape and Ace.
\end{xen}

\paragraph{\xlang{Génération d'une Cartouche}{Cartridge Generation}}

\begin{xfr}
Pour générer une cartouche, il suffit que le source débute par les deux lignes suivantes:
\end{xfr}

\begin{code}
BUILDCPR
BANK 0
\end{code}

\begin{xfr}
La directive \texttt{BUILDCPR} n'a pas vraiment d'utilité, car par défaut, en cas d'utilisation de le directive \texttt{BANK}, c'est une cartouche qui est générée. Mais pour des raisons de lisibilité débuter le source par cette directive permet d'enlever toute ambiguité.
Il n'est pas nécessaire de préciser le point d'entrée, car il est forcément à l'adresse 0.
\end{xfr}

\begin{xen}
This directive is optional, as by default, when a BANK directive is used, a cardridge file is generated. However, it is recommended to explicitly use this directive to indicate that a cardridge will be generated.
%%deprecated directive was supposed to force cartridge generation when using multiple kind of binaries.
\end{xen}

\paragraph{\xlang{Génération d'un Snapshot}{Snapshot Generation}}

\begin{xfr}
La génération d'un snapshot necessite aussi quelques lignes,très similaires à la cartouche. Ici avec un programme dont le point d'entrée à l'adresse \#A000:
\end{xfr}

\begin{xen}
%La génération d'un snapshot necessite aussi quelques lignes,très similaires à la cartouche. Ici avec un programme dont le pointd'entrée à l'adresse \#A000:
\end{xen}

\begin{code}
BUILDSNA
BANK 0
RUN \#A000
\end{code}

\begin{xfr}
Il est aussi possible d'utiliser la directive BANKSET pour generer un fichier snapshot.
\end{xfr}

\subsubsection{BUILDSNA}\index{BUILDSNA}\index{Snapshots}
\begin{verbatim}
BUILDSNA [V2]
\end{verbatim}

\begin{xfr}
L'usage de la directive \texttt{BUILDSNA} indique à Rasm que l'on veut générer un snapshot et non une cartouche.  De plus, à la différence d'une cartouche, il faut préciser le point d'entreé (0 n'étant pas valide).

Le snapshot généré par Rasm inclu un écran de taille classique (le même que sous Basic), les encres sont aux valeurs par défaut du Basic (non clignottantes). Les 3 voies audio sont désactivées, les roms désactivées et le mode d'interruption est 1. Par défaut le snapshot est initialisé avec un 6128 CRTC 0 mais il est possible avec les directives \texttt{SETCRTC} et \texttt{SETCPC} de choisir un autre type de CPC et de CRTC.
%Voici un autre exemple un peu plus sophistiqué, qui utilise plusieurs banques
\end{xfr}


\begin{xen}
This directive forces Rasm to generate a snapshot instead of a cartridge. 
The entry point must be specified (0 is not valid).

By default, the snapshot is targeted for a CPC 6128 with CRTC 0. You can use \texttt{SETCRTC} and \texttt{SETCPC} directives to select an other configuration. 
%The snapshot will include a classic CPC screen (like AMSDOS basic) with default color (non blinking). 
Audio channels are disabled, ROMS are disabled and interrupt mode is set to 1.
\end{xen}


\subsubsection{BANK}\label{BANK}\index{BANK}
\begin{verbatim}
BANK [ROM page number]
BANK [RAM page number]
BANK NEXT
\end{verbatim}

\begin{xfr}
Sélectionner un emplacement ROM (cartouche) ou RAM (snapshot). L'usage de cette instruction active par défaut l'écriture de la cartouche en fin d'assemblage.
Les valeurs possibles vont de 0 à 31. En mode snapshot on peut aussi utiliser cette directive, cette fois avec des valeurs de 0 à 35 (64K de base + 512K d'extension mémoire).

Sans paramètre, ou avec le parametre NEXT, la directive ouvre un nouvel espace mémoire de travail. 
\end{xfr}

\begin{xen}
Selects a ROM bank (while exporting a cartridge) or a RAM slot (for snapshots) for storing code or data. 
For a cartdridge, values range from 0 to 31. In snapshot mode the values range from 0 to 35 (64K base memory + 512K extended memory). 
Used without parameter, BANK directive opens a new memory workspace.

By default, when using BANK, a cartridge will be generated, except if \texttt{BUILDSNA} directive was used previously.

\end{xen}

\begin{code}
BUILDSNA ; recommanded usage when using snapshot is to set it first
BANKSET 0 ; assembling in first 64K
ORG \#1000
RUN \#1000 ; entry point is set to \#1000
\medskip
\ ld b,\#7F
\ ld a,\{page\}mydata ; get gate array value for paging memory
\ out (c),a
\ ld a,(mydata)
\ jr \$
\medskip
BANK 6 ; choose 3th bank of 2nd 64K set
nop
mydata defb \#DD
\medskip
bank 
; bank used without parameter, this is a temporary memory space
; that won't be saved in the snapshot
\medskip
pouet
\  repeat 10
\ \ cpi
\ rend
camion
\ SAVE"another",pouet,camion-pouet
\end{code}

\begin{xfr}
Il existe une option de compatibilité pour la création de snapshot version 2: Certains émulateurs ou cartes hardware ne gèrent pas encore le format v3. Pour rétrograder les snapshots en format v2 (128K maximum, non compressés), il suffit d'ajouter le paramètre V2 après la directive ou de passer le parametre -v2 au lancement de RASM.
\end{xfr}

\begin{xen}
By default, snapshot v3 are exported. There is a compatibility option for selecting snapshot version 2, some emulators or hardware board do not support snapshot v3 yet. Just add arg 'v2' to \texttt{SNAPSHOT} directive or add -v2 option to the command line while invocating RASM.
%(New limitations are 128K max):
\end{xen}


\begin{xen}
\end{xen}


\subsubsection{RUN}\index{RUN}
\begin{verbatim}
RUN <address>[,<gate array configuration>]
\end{verbatim}

\begin{xfr}
Cette directive n'est prise en compte que si on génère un snapshot. Alors l'adresse de démarrage du code sera injectée dans le snapshot. En option on peut spécifier la configuration du gate array, typiquement pour exécuter un programme depuis les 64K de mémoire étendue.
\end{xfr}

\begin{xen}
This option is only used to set then entry point of a snapshot file. It is ignored if a cartridge is exported. 
The gate array can be configured with additional parameters
%Exemple?
\end{xen}

\subsection{\xlang{Directives spécifiques aux snapshots}{Specific Directives for snapshot images}}

\subsubsection{BANKSET}\index{BANKSET}
\begin{verbatim}
BANKSET <64K bloc number>
\end{verbatim}

\begin{xfr}
Sert à sélectionner un emplacement mémoire pour les snapshots, en groupant les pages 4 à 4. Le format snapshot v3 supportant au maximum une extension de 512K, il y a 9 sets mémoire indexés de 0 à 8.

Il est possible d'utiliser \texttt{BANK} et \texttt{BANKSET} en même temps mais il est impératif de ne pas sélectionner la même page à la fois avec \texttt{BANK} et \texttt{BANKSET}. Un contrôle déclenchera une erreur si vous tentez de le faire.

L'appel de cette directive force automatiquement la génération de snapshot.
\end{xfr}

\begin{xen}
BANKSET directive select a set of 4 pages in a row. With snapshot v3, there are 9 memory sets, indexed from 0 to 8.

You may use BANK and BANKSET in a source but you cannot select the same memory space. A check will trigger an error if you try to.

Using this directive enables snapshot output (like BUILDSNA does).
\end{xen}


\subsubsection{SETCPC}\index{SETCPC}

\begin{verbatim}
SETCPC <model>
\end{verbatim}

\begin{xfr}
Choisir le modèle de CPC quand on enregistre un snapshot. Les valeurs autorisées sont:
\end{xfr}

\begin{xen}
Select CPC model when recording a v3 snapshot:
\end{xen}

\begin{tabular}{ll}
0 :& CPC 464 \\
1 :& CPC 664 \\
2 :& CPC 6128 \\
4 :& 464 Plus \\
5 :& 6128 Plus \\
6 :& GX-4000 \\
\end{tabular}

\subsubsection{SETCRTC}\index{SETCRTC}

\begin{verbatim}
SETCRTC <CRTC model>
\end{verbatim}

\begin{xfr}
Choisir le modèle de CRTC quand on enregistre un snapshot. Les valeurs autorisées vont de 0 à 4. Pour rappel, les CPC ont des CRTC 0,1,2 ou 4 et les Plus ou GX-4000 ont tous le CRTC 3.
\end{xfr}

\begin{xen}
Select CRTC model when writing a v3 snapshot file. Value for CRTC model ranges from 0 to 4. CRTC 3 corresponds to CPC Plus and GX-4000, othe values to classic CPCs.
\end{xen}


\subsubsection{BREAKPOINT}\index{BREAKPOINTS}\index{BRK}\label{BREAKPOINT}

\begin{verbatim}
BREAKPOINT [<address>]
[@]BRKlabel
\end{verbatim}

\begin{xfr}

Ajoute un point d'arrêt (ce n'est pas une instruction qui est assemblée) avec pour adresse de break l'adresse de l'instruction suivante ou celle du paramètre optionnel. Les points d'arrêt peuvent être exportés sous forme de fichier brut ou dans les snapshots (compatible avec les émulateurs ACE et Winape) avec l'option -sb.
Note: Tout label qui commence par le préfixe \texttt{BRK} ou \texttt{\at BRK} génère à la fois un label et un point d'arrêt.
\end{xfr}

\begin{xen}
Add a breakpoint (this won't be assembled) to the current address or to the address of the parameter. Breakpoints may be exported to a text file or into snapshots (Winape and ACE compatible) with -sb option.

Another way to set a breakpoint is to prefix a label with \texttt{BRK} or \texttt{\at BRK}.
\end{xen}

\subsubsection{\xlang{Options d'export}{Export option}} \index{Snapshots} \index{Breakpoints} \index{Symbols} \label{options_export_cpc}
\begin{xfr}
Voici les options qui peuvent etre passée en ligne de commande pour specifier les noms des fichiers exportés et activer l'export des symboles et breakpoints pour le format SNA:
\end{xfr}


\begin{xfr}
\begin{itemize}
\item -oc \textless nom du fichier cartouche\textgreater : spécifie le nom complet du fichier cartouche.
\item -oi \textless fichier snapshot \textgreater specifie le nom complet du fichier snapshot
\item -v2 : Créé un snapshot version 2 (export par défaut en version 3)
\item -ss :	Exporte les symboles dans le fichier snapshot (uniquement compatible avec ACE), uniquement avec la version 3+
\item -ok \textless breakpoint filename\textgreater : spécifie le nom complet du fichier breakpoint.
\item -eb : Exporte les breakpoints dans un fichier texte
\item -sb : Exporte les points d'arrêt (breakpoints) dans le fichier snapshot (compatible avec les formats Winape et ACE), uniquement avec la version 3+
\end{itemize}
\end{xfr}

\begin{xen}
\begin{itemize}
\item -oc \textless cartridge filename\textgreater  : set the full filename for cartridge output.
\item -oi \textless snapshot filename \textgreater set the full name of exported snapshot file
\item -v2 : Export a snapshot version 2 (default is version 3)
\item -ss : Export symbols in snapshot file (Winape and ACE emulator format), only with snapshot version 3+
\item -ok \textless breakpoint filename\textgreater :	set the full filename for breakpoint export.
\item -eb : Export breakpoints in a text file
\item -sb : Export breakpoints in snapshot file (Winape and ACE emulator format), only with snapshot version 3+
\end{itemize}
\end{xen}


\subsection{\xlang{Gestion des couleurs du CPC+}{CPC+ Colors}}

\subsubsection{GET\_R, GET\_G, GET\_B}

\begin{verbatim}
GET_R <16 bits RGB value>
GET_G <16 bits RGB value>
GET_B <16 bits RGB value>
\end{verbatim}

\begin{xfr}
Permet, dans une expression, de récuperer l'une des 3 composantes (4 bits) R,G,B d'une couleur au format utilisé par l'ASIC
\end{xfr}

\begin{xen}
Use this in an expression, in order to get one of the 4 bit component of a 16 bit color as used in the ASIC
\end{xen}

\subsubsection{SET\_R, SET\_G, SET\_B}
\begin{verbatim}
SET_R <4 bits value>
SET_G <4 bits value>
SET_B <4 bits value>
\end{verbatim}

\begin{xfr}
Renvoie une valeur 16 bit compatible avec le format de l'ASIC, dont la composante R,G ou B est fixée selon le parametre passé.
\end{xfr}

\begin{xen}
Returns a 16 bit value where the 4-bit value of the color component (R,G,B) is set 
\end{xen}

\begin{code}
  dw (SET\_R 4) | (SET\_G 15) | (SET\_B 0) ; Defines RGB Color  (4,15,0)
\end{code}
\xlang{ou encore}{you also can define your own macro like this:}
\begin{code}
  macro drgb dr,db,dg
  dw SET\_R {dr} | SET\_G {dg} | SET\_B {db}
  mend
\end{code}


\subsection{\xlang{Directives obsolètes}{Deprecated Directives}}

\subsubsection{NOCODE}
\begin{verbatim}
NOCODE
...
CODE
\end{verbatim}

\begin{xfr}
  Cette directive sert à désactiver la génération de code pour une portion de code. Tout se passe comme si le code était généré, mais a la sortie de la zone définie par CODE, la suite du code sera généré la ou la section avait commencé.
  Cette directive servait à définir des structures de données, elle est maintenant obsolète pour cet usage. Elle peut cependant permettre de faire des calculs basés sur du code, de loger le résultat de ces calculs dans des variables, et pourtant ne rien produire en sortie.
\end{xfr}

\begin{xen}
This directive is used for disabling code generation for a portion of code. 
\end{xen}

\subsubsection{WRITE DIRECT}\index{BANK}\index{BANKSET}\index{WRITE DIRECT}

\begin{verbatim}
WRITE DIRECT <lower rom>[,<higher rom>[,<RAM gate array>]]
\end{verbatim}

\begin{xfr}
Cette directive est présente pour compatibilité avec Winape, son usage est déconseillé. Utilisez de préférence les directives BANK ou BANKSET.
En spécifiant une rom basse (entre 0 et 7) ou une rom haute (entre 0 et 31), cette directive a le même effet que la directive BANK.
En spécifiant uniquement l'adresse RAM (n'importe quelle valeur) et en désactivant les numéros de rom avec la valeur -1, on créé à chaque appel un nouvel espace mémoire. On peut ainsi assembler plusieurs code au même emplacement mémoire, mais dans un espace différent. Cet usage est équivalent à la directive BANK sans paramètre.

\end{xfr}

\begin{xen}
This directive is only supported for Winape compatibility. Prefer usage of \texttt{BANK} or \texttt{BANKSET} directives.

%Using lower ROM (from 0 et 7) or higher ROM (from 0 et 31) is like BANK usage.
%Using only RAM gate array (disabling ROM with -1 like Winape does) a new memory workspace is created, like using BANK directive without parameter.
\end{xen}


\subsubsection{LIST, NOLIST, LET}\index{LIST}\index{LET}

\begin{xfr}
Ces directives sont ignorées, elles n'existent que pour la compatibilité avec Maxam et Winape.
\end{xfr}

\begin{xen}
These directives are ignored. Usage for Maxam/Winape compatibility only.
\end{xen}
